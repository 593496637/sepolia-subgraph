/**
 * The Graph Subgraph æ˜ å°„æ–‡ä»¶ - æ™ºèƒ½åˆçº¦äº‹ä»¶å¤„ç†é€»è¾‘
 * 
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - ç›‘å¬æ™ºèƒ½åˆçº¦äº‹ä»¶å¹¶è½¬æ¢ä¸ºå›¾æ•°æ®
 * - ç»´æŠ¤è´¦æˆ·å’Œè½¬è´¦è®°å½•çš„å…³ç³»æ•°æ®
 * - æä¾›é«˜æ•ˆçš„ GraphQL æŸ¥è¯¢æ¥å£
 * - æ”¯æŒå¤æ‚çš„æ•°æ®å…³è”å’ŒèšåˆæŸ¥è¯¢
 * 
 * ğŸ“Š æ•°æ®æ¨¡å‹ï¼š
 * - Account: ä»¥å¤ªåŠè´¦æˆ·å®ä½“
 * - TransferRecord: è½¬è´¦è®°å½•å®ä½“
 * - ä¸€å¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªè´¦æˆ·å¯ä»¥æœ‰å¤šä¸ªè½¬è´¦è®°å½•
 * 
 * ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹ï¼š
 * - AssemblyScript è¯­è¨€ç¼–å†™ï¼ˆç±»ä¼¼ TypeScriptï¼‰
 * - äº‹ä»¶é©±åŠ¨çš„æ•°æ®å¤„ç†æ¨¡å¼
 * - è‡ªåŠ¨æ•°æ®æŒä¹…åŒ–å’Œç´¢å¼•
 * - å®æ—¶æ•°æ®åŒæ­¥å’Œæ›´æ–°
 * 
 * ğŸ’¡ å·¥ä½œæµç¨‹ï¼š
 * 1. æ™ºèƒ½åˆçº¦è§¦å‘ TransferRecord äº‹ä»¶
 * 2. The Graph èŠ‚ç‚¹æ£€æµ‹åˆ°äº‹ä»¶
 * 3. è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
 * 4. æ›´æ–°å›¾æ•°æ®åº“
 * 5. GraphQL API å®æ—¶å¯æŸ¥
 */

// The Graph TypeScript SDK æ ¸å¿ƒæ¨¡å—
import { 
  BigInt,      // å¤§æ•´æ•°ç±»å‹ï¼Œç”¨äºå¤„ç†åŒºå—é“¾æ•°å€¼
  log,         // æ—¥å¿—å·¥å…·ï¼Œç”¨äºè°ƒè¯•å’Œç›‘æ§
  Address,     // ä»¥å¤ªåŠåœ°å€ç±»å‹
  Bytes        // å­—èŠ‚æ•°ç»„ç±»å‹
} from "@graphprotocol/graph-ts"

// ä»¥å¤ªåŠç›¸å…³ç±»å‹ï¼ˆæš‚æœªä½¿ç”¨ä½†ä¿ç•™å¤‡ç”¨ï¼‰
import { ethereum } from "@graphprotocol/graph-ts"

// ä»ç”Ÿæˆçš„ schema æ–‡ä»¶å¯¼å…¥å®ä½“ç±»å‹
// è¿™äº›ç±»å‹æ˜¯æ ¹æ® schema.graphql è‡ªåŠ¨ç”Ÿæˆçš„
import {
  Account,        // è´¦æˆ·å®ä½“ï¼šä»£è¡¨ä»¥å¤ªåŠåœ°å€
  TransferRecord, // è½¬è´¦è®°å½•å®ä½“ï¼šä»£è¡¨ä¸€æ¬¡è½¬è´¦æ“ä½œ
} from "../generated/schema"

// ä»ç”Ÿæˆçš„åˆçº¦ ABI å¯¼å…¥äº‹ä»¶ç±»å‹
// è¿™äº›ç±»å‹æ˜¯æ ¹æ®æ™ºèƒ½åˆçº¦ ABI è‡ªåŠ¨ç”Ÿæˆçš„
import {
  TransferRecord as TransferRecordEvent  // æ™ºèƒ½åˆçº¦çš„ TransferRecord äº‹ä»¶ç±»å‹
} from "../generated/SimpleTransferContract/SimpleTransferContract"

// ==================== å·¥å…·å‡½æ•° ====================

/**
 * è·å–æˆ–åˆ›å»ºè´¦æˆ·å®ä½“çš„è¾…åŠ©å‡½æ•°
 * 
 * ğŸ¯ åŠŸèƒ½ç›®çš„ï¼š
 * - å®ç°è´¦æˆ·å®ä½“çš„å•ä¾‹æ¨¡å¼
 * - ç¡®ä¿æ¯ä¸ªåœ°å€åªæœ‰ä¸€ä¸ªå¯¹åº”çš„ Account å®ä½“
 * - è‡ªåŠ¨åˆå§‹åŒ–æ–°è´¦æˆ·çš„é»˜è®¤å±æ€§
 * - ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§
 * 
 * ğŸ“Š æ•°æ®å¤„ç†æµç¨‹ï¼š
 * 1. å°è¯•ä»å›¾æ•°æ®åº“åŠ è½½ç°æœ‰è´¦æˆ·
 * 2. å¦‚æœè´¦æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è´¦æˆ·å®ä½“
 * 3. è®¾ç½®è´¦æˆ·çš„åŸºæœ¬å±æ€§
 * 4. ä¿å­˜åˆ°å›¾æ•°æ®åº“
 * 5. è¿”å›è´¦æˆ·å®ä½“ä¾›åç»­ä½¿ç”¨
 * 
 * ğŸ”§ æŠ€æœ¯å®ç°ï¼š
 * - ä½¿ç”¨ Account.load() è¿›è¡Œå®ä½“æŸ¥æ‰¾
 * - ä½¿ç”¨æ„é€ å‡½æ•° new Account() åˆ›å»ºæ–°å®ä½“
 * - ä½¿ç”¨ .save() æŒä¹…åŒ–åˆ°æ•°æ®åº“
 * - ç±»å‹æ–­è¨€ç¡®ä¿è¿”å›æ­£ç¡®ç±»å‹
 * 
 * ğŸ’¡ è®¾è®¡æ¨¡å¼ï¼š
 * - å•ä¾‹æ¨¡å¼ï¼šç¡®ä¿æ¯ä¸ªåœ°å€åªæœ‰ä¸€ä¸ªè´¦æˆ·å®ä½“
 * - æ‡’åŠ è½½ï¼šåªåœ¨éœ€è¦æ—¶åˆ›å»ºè´¦æˆ·
 * - åŸå­æ“ä½œï¼šåˆ›å»ºå’Œåˆå§‹åŒ–åœ¨åŒä¸€ä¸ªå‡½æ•°ä¸­å®Œæˆ
 * 
 * ğŸ“ å‚æ•°è¯´æ˜ï¼š
 * @param address - ä»¥å¤ªåŠåœ°å€å­—ç¬¦ä¸²ï¼ˆhex æ ¼å¼ï¼‰
 * @returns Account å®ä½“å¯¹è±¡
 * 
 * âš¡ æ€§èƒ½è€ƒè™‘ï¼š
 * - é¢‘ç¹è°ƒç”¨çš„å‡½æ•°ï¼Œéœ€è¦é«˜æ•ˆçš„æ•°æ®åº“æ“ä½œ
 * - load() æ“ä½œæœ‰ç¼“å­˜æœºåˆ¶ï¼Œé‡å¤æŸ¥è¯¢æ€§èƒ½è¾ƒå¥½
 * - æ–°å»ºè´¦æˆ·æ—¶æ‰æ‰§è¡Œ save() æ“ä½œ
 */
function getOrCreateAccount(address: string): Account {
  // å°è¯•ä»æ•°æ®åº“åŠ è½½ç°æœ‰è´¦æˆ·
  let account = Account.load(address);
  
  // å¦‚æœè´¦æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è´¦æˆ·
  if (account === null) {
    log.info("Creating new account for address {}", [address]);
    
    account = new Account(address);                   // åˆ›å»ºæ–°å®ä½“ï¼ŒID ä¸ºåœ°å€
    account.address = Address.fromString(address);    // è®¾ç½®åœ°å€å­—æ®µ
    account.recordCount = BigInt.fromI32(0);          // åˆå§‹åŒ–è½¬è´¦è®°å½•è®¡æ•°
    account.save();                                   // æŒä¹…åŒ–åˆ°æ•°æ®åº“
  }
  
  return account;  // ç±»å‹ç³»ç»Ÿå·²ç»ç¡®ä¿æ­£ç¡®ç±»å‹
}

// ==================== äº‹ä»¶å¤„ç†å‡½æ•° ====================

/**
 * å¤„ç†æ™ºèƒ½åˆçº¦çš„ TransferRecord äº‹ä»¶
 * 
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - ç›‘å¬æ™ºèƒ½åˆçº¦å‘å‡ºçš„è½¬è´¦è®°å½•äº‹ä»¶
 * - å°†åŒºå—é“¾äº‹ä»¶æ•°æ®è½¬æ¢ä¸ºå›¾æ•°æ®ç»“æ„
 * - ç»´æŠ¤è´¦æˆ·é—´çš„è½¬è´¦å…³ç³»
 * - æ›´æ–°ç›¸å…³å®ä½“çš„ç»Ÿè®¡ä¿¡æ¯
 * 
 * ğŸ“Š æ•°æ®å¤„ç†æµç¨‹ï¼š
 * 1. è®°å½•äº‹ä»¶å¤„ç†å¼€å§‹çš„æ—¥å¿—
 * 2. è·å–æˆ–åˆ›å»ºå‘é€æ–¹è´¦æˆ·å®ä½“
 * 3. è·å–æˆ–åˆ›å»ºæ¥æ”¶æ–¹è´¦æˆ·å®ä½“
 * 4. åˆ›å»ºæ–°çš„è½¬è´¦è®°å½•å®ä½“
 * 5. è®¾ç½®è½¬è´¦è®°å½•çš„æ‰€æœ‰å±æ€§
 * 6. æ›´æ–°å‘é€æ–¹çš„ç»Ÿè®¡æ•°æ®
 * 7. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“
 * 8. è®°å½•äº‹ä»¶å¤„ç†å®Œæˆçš„æ—¥å¿—
 * 
 * ğŸ”— å…³ç³»å»ºç«‹ï¼š
 * - TransferRecord.from â†’ Account (å¤šå¯¹ä¸€)
 * - TransferRecord.to â†’ Account (å¤šå¯¹ä¸€)
 * - ä¸€ä¸ªè´¦æˆ·å¯ä»¥å‚ä¸å¤šæ¬¡è½¬è´¦
 * - æ”¯æŒ GraphQL çš„å…³è”æŸ¥è¯¢
 * 
 * ğŸ†” å”¯ä¸€æ ‡è¯†ç”Ÿæˆï¼š
 * - ä½¿ç”¨ "äº¤æ˜“å“ˆå¸Œ-æ—¥å¿—ç´¢å¼•" ä½œä¸ºè½¬è´¦è®°å½•ID
 * - ç¡®ä¿æ¯ä¸ªäº‹ä»¶å¯¹åº”å”¯ä¸€çš„æ•°æ®åº“è®°å½•
 * - é¿å…é‡å¤å¤„ç†ç›¸åŒäº‹ä»¶
 * 
 * ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤ï¼š
 * - æ›´æ–°å‘é€æ–¹è´¦æˆ·çš„è½¬è´¦æ¬¡æ•°è®¡æ•°
 * - ä¸ºåç»­çš„åˆ†ææŸ¥è¯¢æä¾›èšåˆæ•°æ®
 * - æ”¯æŒæŒ‰è´¦æˆ·æŸ¥è¯¢è½¬è´¦å†å²
 * 
 * ğŸ” æ—¥å¿—è®°å½•ï¼š
 * - å¤„ç†å¼€å§‹ï¼šè®°å½•äº‹ä»¶åŸºæœ¬ä¿¡æ¯
 * - å¤„ç†å®Œæˆï¼šè®°å½•è½¬è´¦è®°å½•ID
 * - ä¾¿äºè°ƒè¯•å’Œç›‘æ§å¤„ç†çŠ¶æ€
 * 
 * ğŸ“ äº‹ä»¶å‚æ•°è¯´æ˜ï¼š
 * @param event - æ™ºèƒ½åˆçº¦è§¦å‘çš„ TransferRecord äº‹ä»¶
 * @param event.params.recordId - è½¬è´¦è®°å½•çš„å”¯ä¸€æ ‡è¯†
 * @param event.params.from - å‘é€æ–¹åœ°å€
 * @param event.params.to - æ¥æ”¶æ–¹åœ°å€
 * @param event.params.value - è½¬è´¦é‡‘é¢ (Wei)
 * @param event.params.message - è½¬è´¦å¤‡æ³¨ä¿¡æ¯
 * @param event.params.timestamp - è½¬è´¦æ—¶é—´æˆ³
 * @param event.block.number - äº‹ä»¶æ‰€åœ¨åŒºå—å·
 * @param event.transaction.hash - äº‹ä»¶æ‰€åœ¨äº¤æ˜“å“ˆå¸Œ
 * @param event.logIndex - äº‹ä»¶åœ¨äº¤æ˜“ä¸­çš„æ—¥å¿—ç´¢å¼•
 * 
 * âš¡ æ€§èƒ½ä¼˜åŒ–ï¼š
 * - ä½¿ç”¨ getOrCreateAccount() é¿å…é‡å¤åˆ›å»ºè´¦æˆ·
 * - æ‰¹é‡æ›´æ–°å‡å°‘æ•°æ®åº“å†™å…¥æ¬¡æ•°
 * - æ—¥å¿—è®°å½•å¸®åŠ©ç›‘æ§å¤„ç†æ€§èƒ½
 * 
 * ğŸŒ GraphQL æŸ¥è¯¢æ”¯æŒï¼š
 * å¤„ç†åçš„æ•°æ®æ”¯æŒä»¥ä¸‹æŸ¥è¯¢æ¨¡å¼ï¼š
 * - æŒ‰è´¦æˆ·æŸ¥è¯¢æ‰€æœ‰è½¬è´¦è®°å½•
 * - æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢è½¬è´¦è®°å½•
 * - æŒ‰é‡‘é¢èŒƒå›´æŸ¥è¯¢è½¬è´¦è®°å½•
 * - å…³è”æŸ¥è¯¢å‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¿¡æ¯
 */
export function handleTransferRecord(event: TransferRecordEvent): void {
  // è®°å½•äº‹ä»¶å¤„ç†å¼€å§‹ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§
  log.info("Processing TransferRecord event from {} to {} with value {}", [
    event.params.from.toHexString(),  // å‘é€æ–¹åœ°å€
    event.params.to.toHexString(),    // æ¥æ”¶æ–¹åœ°å€
    event.params.value.toString()     // è½¬è´¦é‡‘é¢
  ]);

  // è·å–åœ°å€å­—ç¬¦ä¸²ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
  const fromAddress = event.params.from.toHexString();
  const toAddress = event.params.to.toHexString();

  // è·å–æˆ–åˆ›å»ºå‘é€æ–¹è´¦æˆ·å®ä½“
  let fromAccount = getOrCreateAccount(fromAddress);
  // æ›´æ–°å‘é€æ–¹çš„è½¬è´¦è®°å½•è®¡æ•°ï¼ˆç»Ÿè®¡ä¿¡æ¯ï¼‰
  fromAccount.recordCount = fromAccount.recordCount.plus(BigInt.fromI32(1));
  fromAccount.save();  // ä¿å­˜å‘é€æ–¹è´¦æˆ·çš„æ›´æ–°

  // è·å–æˆ–åˆ›å»ºæ¥æ”¶æ–¹è´¦æˆ·å®ä½“
  let toAccount = getOrCreateAccount(toAddress);
  // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰æ›´æ–°æ¥æ”¶æ–¹çš„è®¡æ•°ï¼Œåªç»Ÿè®¡ä¸»åŠ¨å‘é€çš„æ¬¡æ•°

  // åˆ›å»ºè½¬è´¦è®°å½•å®ä½“
  // ID æ ¼å¼ï¼š"äº¤æ˜“å“ˆå¸Œ-æ—¥å¿—ç´¢å¼•"ï¼Œç¡®ä¿å”¯ä¸€æ€§
  const transferRecordId = event.transaction.hash.toHexString() + "-" + event.logIndex.toString();
  let transferRecord = new TransferRecord(transferRecordId);
  
  // è®¾ç½®è½¬è´¦è®°å½•çš„æ‰€æœ‰å±æ€§
  transferRecord.recordId = event.params.recordId;           // æ™ºèƒ½åˆçº¦ä¸­çš„è®°å½•ID
  transferRecord.from = fromAccount.id;                      // å…³è”åˆ°å‘é€æ–¹è´¦æˆ·
  transferRecord.to = toAccount.id;                          // å…³è”åˆ°æ¥æ”¶æ–¹è´¦æˆ·
  transferRecord.value = event.params.value;                 // è½¬è´¦é‡‘é¢
  transferRecord.message = event.params.message;             // è½¬è´¦å¤‡æ³¨
  transferRecord.timestamp = event.params.timestamp;         // è½¬è´¦æ—¶é—´æˆ³
  transferRecord.blockNumber = event.block.number;           // åŒºå—å·
  transferRecord.transactionHash = event.transaction.hash;   // äº¤æ˜“å“ˆå¸Œ

  // ä¿å­˜è½¬è´¦è®°å½•åˆ°æ•°æ®åº“
  transferRecord.save();

  // è®°å½•äº‹ä»¶å¤„ç†å®Œæˆï¼Œè¾“å‡ºè½¬è´¦è®°å½•IDä¾¿äºè¿½è¸ª
  log.info("Successfully processed TransferRecord with ID {} at block {}", [
    transferRecord.recordId.toHexString(),
    event.block.number.toString()
  ]);
}