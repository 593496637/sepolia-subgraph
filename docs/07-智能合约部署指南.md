# 🚀 智能合约部署指南

> 📖 **完整流程**：从合约编写到生产环境部署的详细指南

## 🎯 部署目标

通过本指南，你将学会：
- ✅ 本地开发环境搭建
- ✅ 合约编译和测试流程
- ✅ 测试网部署和验证
- ✅ 主网部署最佳实践
- ✅ 部署后的监控和维护

---

## 🛠️ 第一部分：开发环境搭建

### 1.1 必需工具安装

```bash
# 1. 安装 Node.js (版本 18+)
node --version

# 2. 安装 Hardhat 开发框架
npm install -g hardhat

# 3. 创建新项目
mkdir my-contract-project
cd my-contract-project
npx hardhat init

# 4. 安装常用插件
npm install --save-dev @nomiclabs/hardhat-ethers ethers @nomiclabs/hardhat-etherscan
```

### 1.2 项目结构设置

```
my-contract-project/
├── contracts/           # 智能合约源码
│   └── SimpleTransfer.sol
├── scripts/            # 部署脚本
│   └── deploy.js
├── test/              # 测试文件
│   └── SimpleTransfer.test.js
├── hardhat.config.js  # Hardhat 配置
├── package.json
└── .env              # 环境变量 (不要提交到 git)
```

### 1.3 Hardhat 配置

```javascript
// hardhat.config.js
require('@nomiclabs/hardhat-ethers');
require('@nomiclabs/hardhat-etherscan');
require('dotenv').config();

module.exports = {
  solidity: {
    version: "0.8.30",
    settings: {
      optimizer: {
        enabled: true,
        runs: 200
      }
    }
  },
  networks: {
    // 本地开发网络
    hardhat: {
      chainId: 31337
    },
    
    // Sepolia 测试网
    sepolia: {
      url: process.env.SEPOLIA_URL || "https://rpc.sepolia.org",
      accounts: process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : [],
      gasPrice: "auto",
      gas: "auto"
    },
    
    // 以太坊主网
    mainnet: {
      url: process.env.MAINNET_URL || "",
      accounts: process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : [],
      gasPrice: "auto"
    }
  },
  
  // Etherscan API 配置（用于合约验证）
  etherscan: {
    apiKey: process.env.ETHERSCAN_API_KEY
  }
};
```

### 1.4 环境变量配置

```bash
# .env 文件内容
PRIVATE_KEY=你的私钥（不要包含0x前缀）
SEPOLIA_URL=https://rpc.sepolia.org
MAINNET_URL=https://mainnet.infura.io/v3/你的项目ID
ETHERSCAN_API_KEY=你的Etherscan API Key

# ⚠️ 重要安全提示：
# 1. 永远不要将 .env 文件提交到版本控制系统
# 2. 使用专门的部署账户，不要使用主账户
# 3. 为不同环境使用不同的私钥
```

---

## 📝 第二部分：合约准备和测试

### 2.1 合约代码准备

```solidity
// contracts/SimpleTransferContract.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

contract SimpleTransferContract {
    // 合约版本 - 用于升级管理
    string public constant VERSION = "1.0.0";
    
    // 部署者地址
    address public deployer;
    
    // 部署时间
    uint256 public deploymentTime;
    
    // 事件定义
    event TransferRecord(
        address indexed from,
        address indexed to,
        uint256 value,
        uint256 timestamp,
        string message,
        bytes32 recordId
    );
    
    // 部署事件
    event Deployed(address indexed deployer, uint256 timestamp, string version);
    
    constructor() {
        deployer = msg.sender;
        deploymentTime = block.timestamp;
        emit Deployed(msg.sender, block.timestamp, VERSION);
    }
    
    // ... 其他合约逻辑
}
```

### 2.2 编写部署脚本

```javascript
// scripts/deploy.js
const { ethers } = require("hardhat");

async function main() {
    console.log("🚀 开始部署 SimpleTransferContract...");
    
    // 获取部署账户
    const [deployer] = await ethers.getSigners();
    console.log("📋 部署账户:", deployer.address);
    
    // 检查账户余额
    const balance = await deployer.getBalance();
    console.log("💰 账户余额:", ethers.utils.formatEther(balance), "ETH");
    
    // 获取当前 Gas 价格
    const gasPrice = await ethers.provider.getGasPrice();
    console.log("⛽ 当前 Gas 价格:", ethers.utils.formatUnits(gasPrice, "gwei"), "Gwei");
    
    // 部署合约
    const SimpleTransferContract = await ethers.getContractFactory("SimpleTransferContract");
    
    // 估算部署成本
    const deployTx = SimpleTransferContract.getDeployTransaction();
    const estimatedGas = await ethers.provider.estimateGas(deployTx);
    const deploymentCost = gasPrice.mul(estimatedGas);
    
    console.log("📊 估算部署成本:", ethers.utils.formatEther(deploymentCost), "ETH");
    
    // 确认部署
    console.log("⏳ 部署中...");
    const contract = await SimpleTransferContract.deploy({
        gasPrice: gasPrice,
        gasLimit: estimatedGas.add(50000) // 添加额外 Gas 缓冲
    });
    
    console.log("📄 合约部署交易:", contract.deployTransaction.hash);
    console.log("⏳ 等待确认...");
    
    // 等待部署确认
    await contract.deployed();
    
    console.log("✅ 合约部署成功!");
    console.log("📍 合约地址:", contract.address);
    console.log("🔗 区块号:", contract.deployTransaction.blockNumber);
    
    // 验证部署
    console.log("🔍 验证部署...");
    const version = await contract.VERSION();
    const deployer_addr = await contract.deployer();
    
    console.log("📋 合约版本:", version);
    console.log("👤 部署者:", deployer_addr);
    
    // 保存部署信息
    const deploymentInfo = {
        contractAddress: contract.address,
        deploymentTxHash: contract.deployTransaction.hash,
        blockNumber: contract.deployTransaction.blockNumber,
        deployer: deployer.address,
        timestamp: new Date().toISOString(),
        network: hre.network.name,
        version: version
    };
    
    console.log("💾 部署信息:", JSON.stringify(deploymentInfo, null, 2));
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error("❌ 部署失败:", error);
        process.exit(1);
    });
```

### 2.3 本地测试

```bash
# 1. 编译合约
npx hardhat compile

# 2. 运行测试
npx hardhat test

# 3. 在本地网络部署
npx hardhat node  # 另一个终端运行
npx hardhat run scripts/deploy.js --network localhost

# 4. 交互测试
npx hardhat console --network localhost
```

---

## 🌐 第三部分：测试网部署

### 3.1 Sepolia 测试网部署

```bash
# 1. 获取测试 ETH
# 访问 https://sepoliafaucet.com/ 获取测试币

# 2. 部署到 Sepolia
npx hardhat run scripts/deploy.js --network sepolia

# 3. 验证部署结果
npx hardhat verify --network sepolia <合约地址>
```

### 3.2 部署验证检查清单

```javascript
// scripts/verify-deployment.js
const { ethers } = require("hardhat");

async function verifyDeployment(contractAddress) {
    console.log("🔍 验证合约部署...");
    
    const contract = await ethers.getContractAt("SimpleTransferContract", contractAddress);
    
    try {
        // 检查基本信息
        const version = await contract.VERSION();
        const deployer = await contract.deployer();
        const deploymentTime = await contract.deploymentTime();
        
        console.log("✅ 合约可访问");
        console.log("📋 版本:", version);
        console.log("👤 部署者:", deployer);
        console.log("⏰ 部署时间:", new Date(deploymentTime * 1000).toISOString());
        
        // 检查核心功能
        const totalRecords = await contract.totalRecords();
        console.log("📊 总记录数:", totalRecords.toString());
        
        // 发送测试交易（如果需要）
        // const tx = await contract.recordTransfer(
        //     "0x...", 
        //     ethers.utils.parseEther("0.1"), 
        //     "测试记录"
        // );
        // await tx.wait();
        // console.log("✅ 测试交易成功");
        
        console.log("🎉 合约验证完成!");
        return true;
        
    } catch (error) {
        console.error("❌ 验证失败:", error.message);
        return false;
    }
}

// 使用方法
// npx hardhat run scripts/verify-deployment.js --network sepolia
// 然后手动输入合约地址
```

### 3.3 Etherscan 验证

```bash
# 自动验证
npx hardhat verify --network sepolia <合约地址> [构造函数参数]

# 如果自动验证失败，使用手动验证
# 1. 访问 https://sepolia.etherscan.io/
# 2. 搜索合约地址
# 3. 点击 "Contract" -> "Verify and Publish"
# 4. 填入合约源码和编译设置
```

---

## 🏭 第四部分：主网部署准备

### 4.1 主网部署前检查清单

**安全检查**
- [ ] 代码审计完成
- [ ] 单元测试覆盖率 > 90%
- [ ] 集成测试通过
- [ ] 在测试网长期运行验证
- [ ] 多重签名钱包设置
- [ ] 紧急暂停机制测试

**技术检查**
- [ ] Gas 优化完成
- [ ] 合约大小 < 24KB
- [ ] 所有依赖库安全
- [ ] 升级机制（如需要）测试
- [ ] 监控和报警设置

**运营检查**
- [ ] 部署资金准备充足
- [ ] 官方文档完成
- [ ] 社区通知准备
- [ ] 应急响应预案

### 4.2 主网部署脚本

```javascript
// scripts/mainnet-deploy.js
const { ethers } = require("hardhat");
const readline = require('readline');

async function confirmDeployment() {
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });
    
    return new Promise((resolve) => {
        rl.question('⚠️  确认部署到主网？这将消耗真实的 ETH！(yes/no): ', (answer) => {
            rl.close();
            resolve(answer.toLowerCase() === 'yes');
        });
    });
}

async function mainnetDeploy() {
    console.log("🚨 主网部署流程启动");
    
    // 网络检查
    const network = await ethers.provider.getNetwork();
    if (network.chainId !== 1) {
        throw new Error("❌ 不是以太坊主网!");
    }
    
    // 部署者检查
    const [deployer] = await ethers.getSigners();
    const balance = await deployer.getBalance();
    const minBalance = ethers.utils.parseEther("0.1"); // 最少 0.1 ETH
    
    if (balance.lt(minBalance)) {
        throw new Error("❌ 账户余额不足!");
    }
    
    console.log("📋 部署账户:", deployer.address);
    console.log("💰 账户余额:", ethers.utils.formatEther(balance), "ETH");
    
    // Gas 价格检查
    const gasPrice = await ethers.provider.getGasPrice();
    const gasPriceGwei = ethers.utils.formatUnits(gasPrice, "gwei");
    
    if (parseFloat(gasPriceGwei) > 50) {
        console.log("⚠️  当前 Gas 价格较高:", gasPriceGwei, "Gwei");
        console.log("💡 建议等待 Gas 价格降低后再部署");
    }
    
    // 用户确认
    if (!await confirmDeployment()) {
        console.log("❌ 用户取消部署");
        return;
    }
    
    // 开始部署
    console.log("🚀 开始主网部署...");
    
    const SimpleTransferContract = await ethers.getContractFactory("SimpleTransferContract");
    const contract = await SimpleTransferContract.deploy({
        gasPrice: gasPrice
    });
    
    console.log("📄 部署交易:", contract.deployTransaction.hash);
    console.log("⏳ 等待确认中...");
    
    await contract.deployed();
    
    console.log("🎉 主网部署成功!");
    console.log("📍 合约地址:", contract.address);
    
    // 保存重要信息
    const deploymentData = {
        contractAddress: contract.address,
        deploymentTx: contract.deployTransaction.hash,
        deployer: deployer.address,
        timestamp: new Date().toISOString(),
        gasPrice: gasPriceGwei,
        network: "mainnet"
    };
    
    console.log("💾 请备份以下部署信息:");
    console.log(JSON.stringify(deploymentData, null, 2));
}

mainnetDeploy()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error("❌ 主网部署失败:", error);
        process.exit(1);
    });
```

---

## 📊 第五部分：部署后操作

### 5.1 合约验证和发布

```bash
# 1. Etherscan 验证
npx hardhat verify --network mainnet <合约地址>

# 2. 创建官方仓库标签
git tag -a v1.0.0 -m "Production deployment v1.0.0"
git push origin v1.0.0
```

### 5.2 监控设置

```javascript
// scripts/monitor.js
const { ethers } = require("hardhat");

async function setupMonitoring(contractAddress) {
    const contract = await ethers.getContractAt("SimpleTransferContract", contractAddress);
    
    // 监听事件
    contract.on("TransferRecord", (from, to, value, timestamp, message, recordId) => {
        console.log(`🔔 新转账记录: ${from} -> ${to}, 金额: ${ethers.utils.formatEther(value)} ETH`);
        
        // 发送通知到监控系统
        // sendToSlack() 或 sendToTelegram() 等
    });
    
    console.log("👁️ 监控系统已启动");
}
```

### 5.3 文档更新

更新项目文档，包括：
- 合约地址
- ABI 文件
- 使用示例
- API 文档

---

## 🔧 第六部分：故障排除

### 6.1 常见部署问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| Gas 不足 | Gas limit 设置过低 | 增加 gasLimit 或使用 "auto" |
| 交易回滚 | 合约逻辑错误 | 检查 require 条件和逻辑 |
| 验证失败 | 编译设置不匹配 | 确保 solc 版本和优化设置一致 |
| 网络连接问题 | RPC 节点不可用 | 更换 RPC 端点 |
| 私钥错误 | 私钥格式错误 | 检查私钥格式，不要包含 0x |

### 6.2 部署回滚策略

如果部署后发现重大问题：

```solidity
// 紧急暂停模式
contract EmergencyPause {
    bool public paused = false;
    address public owner;
    
    modifier whenNotPaused() {
        require(!paused, "Contract is paused");
        _;
    }
    
    modifier onlyOwner() {
        require(msg.sender == owner, "Not owner");
        _;
    }
    
    function pause() external onlyOwner {
        paused = true;
    }
    
    function unpause() external onlyOwner {
        paused = false;
    }
}
```

---

## 📈 第七部分：部署最佳实践

### 7.1 版本管理

```javascript
// 语义化版本管理
contract SimpleTransferContract {
    string public constant VERSION = "1.2.3"; // 主版本.次版本.补丁版本
    
    // 版本历史记录
    event VersionUpdated(string oldVersion, string newVersion, uint256 timestamp);
}
```

### 7.2 多环境管理

```javascript
// hardhat.config.js - 多环境配置
const configs = {
    development: {
        gas: 8000000,
        gasPrice: 1000000000, // 1 Gwei
    },
    staging: {
        gas: 6000000,
        gasPrice: 2000000000, // 2 Gwei
    },
    production: {
        gas: 5000000,
        gasPrice: null, // 使用网络当前价格
    }
};

module.exports = {
    networks: {
        sepolia: {
            ...baseConfig,
            ...configs.development
        },
        mainnet: {
            ...baseConfig,
            ...configs.production
        }
    }
};
```

### 7.3 自动化部署

```yaml
# .github/workflows/deploy.yml
name: Smart Contract Deployment

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Deploy to testnet
      if: contains(github.ref, 'beta')
      run: npx hardhat run scripts/deploy.js --network sepolia
      env:
        PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
        SEPOLIA_URL: ${{ secrets.SEPOLIA_URL }}
    
    - name: Deploy to mainnet
      if: contains(github.ref, 'release')
      run: npx hardhat run scripts/mainnet-deploy.js --network mainnet
      env:
        PRIVATE_KEY: ${{ secrets.MAINNET_PRIVATE_KEY }}
        MAINNET_URL: ${{ secrets.MAINNET_URL }}
```

---

## ✅ 部署检查清单

### 部署前
- [ ] 代码审计完成
- [ ] 测试覆盖率达标
- [ ] 在测试网验证功能
- [ ] Gas 优化完成
- [ ] 文档编写完整
- [ ] 私钥和资金准备

### 部署中
- [ ] 网络环境确认
- [ ] Gas 价格合理
- [ ] 交易确认成功
- [ ] 合约地址保存
- [ ] 部署信息备份

### 部署后
- [ ] 功能验证通过
- [ ] Etherscan 验证
- [ ] 监控系统启动
- [ ] 文档更新发布
- [ ] 社区通知完成

---

## 🎯 总结

智能合约部署是一个需要谨慎操作的过程，特别是主网部署。记住：

1. **测试至上**：在测试网充分验证所有功能
2. **安全第一**：使用多重签名和紧急暂停机制
3. **文档完善**：提供清晰的使用文档
4. **监控及时**：建立完善的监控和报警系统
5. **备份重要**：妥善保存部署信息和私钥

🚀 **准备好了吗？现在就开始你的智能合约部署之旅吧！**